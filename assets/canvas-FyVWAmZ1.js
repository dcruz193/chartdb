import{r as i,j as e,S as ut,R as U,b as L,g as mt,T as Z,e as W,f as Y,q as Re,p as ft}from"./index-D22tuFcn.js";import{d as le,u as Te,e as gt,b as de,f as xt,g as We,P as te,h as we,i as yt,j as bt,k as Ye,c as Ne,l as jt,m as kt,n as Ue,o as vt,p as Ct,q as wt,r as _e,W as Tt,s as Nt,t as Be,N as It,I as St,v as Et,w as Rt,x as _t,y as Mt,z as Ot,M as Dt,A as zt,T as At,L as Ft,B as Ht,D as Ve,E as Lt,F as Pt,G as pe,H as Bt,J as Vt,K as $e,O as Oe,Q as $t,S as Gt,U as Zt,V as be,X as Wt,Y as Yt,Z as Ut,_ as Kt,$ as Xt}from"./canvas-utils-C5DtV3-P.js";import{B as se}from"./label-DEegoE4u.js";import{a as $,k as je,K as ke,u as Ke}from"./theme-provider-qAUrzat1.js";import{B as qt}from"./badge-BBZzLzuh.js";import{u as Jt}from"./databases-C9KYyYJn.js";import{D as Qt}from"./database-type-C2NNW5SW.js";/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const es=$("GripVertical",[["circle",{cx:"9",cy:"12",r:"1",key:"1vctgf"}],["circle",{cx:"9",cy:"5",r:"1",key:"hp0tcf"}],["circle",{cx:"9",cy:"19",r:"1",key:"fkjjf6"}],["circle",{cx:"15",cy:"12",r:"1",key:"1tmaij"}],["circle",{cx:"15",cy:"5",r:"1",key:"19l28e"}],["circle",{cx:"15",cy:"19",r:"1",key:"f4zoj3"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ts=$("Group",[["path",{d:"M3 7V5c0-1.1.9-2 2-2h2",key:"adw53z"}],["path",{d:"M17 3h2c1.1 0 2 .9 2 2v2",key:"an4l38"}],["path",{d:"M21 17v2c0 1.1-.9 2-2 2h-2",key:"144t0e"}],["path",{d:"M7 21H5c-1.1 0-2-.9-2-2v-2",key:"rtnfgi"}],["rect",{width:"7",height:"5",x:"7",y:"7",rx:"1",key:"1eyiv7"}],["rect",{width:"7",height:"5",x:"10",y:"12",rx:"1",key:"1qlmkx"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ss=$("Magnet",[["path",{d:"m6 15-4-4 6.75-6.77a7.79 7.79 0 0 1 11 11L13 22l-4-4 6.39-6.36a2.14 2.14 0 0 0-3-3L6 15",key:"1i3lhw"}],["path",{d:"m5 8 4 4",key:"j6kj7e"}],["path",{d:"m12 15 4 4",key:"lnac28"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const as=$("Redo",[["path",{d:"M21 7v6h-6",key:"3ptur4"}],["path",{d:"M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7",key:"1kgawr"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const os=$("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ns=$("Scan",[["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const is=$("Table",[["path",{d:"M12 3v18",key:"108xh3"}],["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rs=$("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ls=$("Undo",[["path",{d:"M3 7v6h6",key:"1v2h90"}],["path",{d:"M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13",key:"1r6uu6"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ds=$("ZoomIn",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cs=$("ZoomOut",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);var hs=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","span","svg","ul"],ps=hs.reduce((s,a)=>{const t=i.forwardRef((h,l)=>{const{asChild:p,...m}=h,u=p?ut:a;return typeof window<"u"&&(window[Symbol.for("radix-ui")]=!0),e.jsx(u,{...m,ref:l})});return t.displayName=`Primitive.${a}`,{...s,[a]:t}},{}),us="Separator",Ge="horizontal",ms=["horizontal","vertical"],Xe=i.forwardRef((s,a)=>{const{decorative:t,orientation:h=Ge,...l}=s,p=fs(h)?h:Ge,u=t?{role:"none"}:{"aria-orientation":p==="vertical"?p:void 0,role:"separator"};return e.jsx(ps.div,{"data-orientation":p,...u,...l,ref:a})});Xe.displayName=us;function fs(s){return ms.includes(s)}var qe=Xe;const Ce=U.forwardRef(({className:s,orientation:a="horizontal",decorative:t=!0,...h},l)=>e.jsx(qe,{ref:l,decorative:t,orientation:a,className:L("shrink-0 bg-border",a==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",s),...h}));Ce.displayName=qe.displayName;var gs=function s(a,t){if(a===t)return!0;if(a&&t&&typeof a=="object"&&typeof t=="object"){if(a.constructor!==t.constructor)return!1;var h,l,p;if(Array.isArray(a)){if(h=a.length,h!=t.length)return!1;for(l=h;l--!==0;)if(!s(a[l],t[l]))return!1;return!0}if(a.constructor===RegExp)return a.source===t.source&&a.flags===t.flags;if(a.valueOf!==Object.prototype.valueOf)return a.valueOf()===t.valueOf();if(a.toString!==Object.prototype.toString)return a.toString()===t.toString();if(p=Object.keys(a),h=p.length,h!==Object.keys(t).length)return!1;for(l=h;l--!==0;)if(!Object.prototype.hasOwnProperty.call(t,p[l]))return!1;for(l=h;l--!==0;){var m=p[l];if(!s(a[m],t[m]))return!1}return!0}return a!==a&&t!==t};const ve=mt(gs),xs=({id:s,sourceX:a,sourceY:t,targetX:h,targetY:l,source:p,target:m,selected:u,data:C})=>{var oe,ne;const{getInternalNode:E,getEdge:k}=le(),{openRelationshipFromSidebar:S,selectSidebarSection:O}=Te(),{checkIfRelationshipRemoved:D,checkIfNewRelationship:y}=gt(),{relationships:v}=de(),d=C==null?void 0:C.relationship,w=i.useCallback(()=>{O("relationships"),S(s)},[s,S,O]),g=i.useMemo(()=>v.filter(j=>j.targetTableId===m&&j.sourceTableId===p||j.targetTableId===p&&j.sourceTableId===m).findIndex(j=>j.id===s),[v,s,p,m]),M=E(p),A=E(m),T=k(s),G=(ne=(oe=T==null?void 0:T.sourceHandle)==null?void 0:oe.startsWith)!=null&&ne.call(oe,xt)?"right":"left",b=(M==null?void 0:M.measured.width)??0,R=G==="left"?a+3:a-b-10,F=G==="left"?a+b+9:a,K=(A==null?void 0:A.measured.width)??0,P=h-1,X=h+K+10,{sourceSide:ae,targetSide:J}=i.useMemo(()=>{const j={leftToLeft:Math.abs(R-P),leftToRight:Math.abs(R-X),rightToLeft:Math.abs(F-P),rightToRight:Math.abs(F-X)},H=Math.min(j.leftToLeft,j.leftToRight,j.rightToLeft,j.rightToRight);switch(Object.keys(j).find(xe=>j[xe]===H)){case"leftToRight":return{sourceSide:"left",targetSide:"right"};case"rightToLeft":return{sourceSide:"right",targetSide:"left"};case"rightToRight":return{sourceSide:"right",targetSide:"right"};default:return{sourceSide:"left",targetSide:"left"}}},[R,F,P,X]),[ue]=i.useMemo(()=>We({sourceX:ae==="left"?R:F,sourceY:t,targetX:J==="left"?P:X,targetY:l,borderRadius:14,sourcePosition:ae==="left"?te.Left:te.Right,targetPosition:J==="left"?te.Left:te.Right,offset:(g+1)*14}),[ae,J,R,F,P,X,t,l,g]),me=i.useMemo(()=>we({cardinality:(d==null?void 0:d.sourceCardinality)??"one",selected:u??!1,side:ae}),[d==null?void 0:d.sourceCardinality,u,ae]),re=i.useMemo(()=>we({cardinality:(d==null?void 0:d.targetCardinality)??"one",selected:u??!1,side:J}),[d==null?void 0:d.targetCardinality,u,J]),fe=i.useMemo(()=>d!=null&&d.id?y({relationshipId:d.id}):!1,[y,d==null?void 0:d.id]),ge=i.useMemo(()=>d!=null&&d.id?D({relationshipId:d.id}):!1,[D,d==null?void 0:d.id]);return e.jsxs(e.Fragment,{children:[e.jsx("path",{id:s,d:ue,markerStart:`url(#${me})`,markerEnd:`url(#${re})`,fill:"none",className:L(["react-flow__edge-path",`!stroke-2 ${u?"!stroke-pink-600":"!stroke-slate-400"}`,{"!stroke-green-500 !stroke-[3px]":fe,"!stroke-red-500 !stroke-[3px]":ge}]),onClick:j=>{j.detail===2&&w()}}),e.jsx("path",{d:ue,fill:"none",strokeOpacity:0,strokeWidth:20,className:"react-flow__edge-interaction",onClick:j=>{j.detail===2&&w()}})]})},Je=U.forwardRef(({className:s,...a},t)=>e.jsx("div",{ref:t,className:L("rounded-xl border bg-card text-card-foreground shadow",s),...a}));Je.displayName="Card";const ys=U.forwardRef(({className:s,...a},t)=>e.jsx("div",{ref:t,className:L("flex flex-col space-y-1.5 p-6",s),...a}));ys.displayName="CardHeader";const bs=U.forwardRef(({className:s,...a},t)=>e.jsx("h3",{ref:t,className:L("font-semibold leading-none tracking-tight",s),...a}));bs.displayName="CardTitle";const js=U.forwardRef(({className:s,...a},t)=>e.jsx("p",{ref:t,className:L("text-sm text-muted-foreground",s),...a}));js.displayName="CardDescription";const Qe=U.forwardRef(({className:s,...a},t)=>e.jsx("div",{ref:t,className:L("p-6 pt-0",s),...a}));Qe.displayName="CardContent";const ks=U.forwardRef(({className:s,...a},t)=>e.jsx("div",{ref:t,className:L("flex items-center p-6 pt-0",s),...a}));ks.displayName="CardFooter";const ie=U.forwardRef((s,a)=>{const{className:t,...h}=s;return e.jsx(se,{ref:a,variant:"ghost",className:L("w-[36px] p-2 hover:bg-primary-foreground",t),...h})});ie.displayName=se.displayName;const vs=()=>{const{getNodes:s,getViewport:a}=le(),[t,h]=i.useState(!1),l=i.useCallback(()=>{var d,w;const m=s(),u=a();if(m.length===0){h(!1);return}const C=m.filter(g=>!g.hidden);if(C.length===0){h(!1);return}const E=-u.x/u.zoom,k=-u.y/u.zoom,S=((d=document.getElementById("canvas"))==null?void 0:d.clientWidth)||window.innerWidth,O=((w=document.getElementById("canvas"))==null?void 0:w.clientHeight)||window.innerHeight,D=E+S/u.zoom,y=k+O/u.zoom,v=C.some(g=>{var F;let M=g.width||0,A=g.height||0;if(g.type==="table"&&((F=g.data)!=null&&F.table)){const P=yt(g.data.table);M=P.width,A=P.height}const T=g.position.x,G=g.position.y,b=T+M,R=G+A;return b>=E&&T<=D&&R>=k&&G<=y});h(!v)},[s,a]),p=bt(l,1e3);return Ye({onEnd:()=>{p()}}),{isLostInCanvas:t}},Ze=s=>`${Math.round(s*100)}%`,Cs=({readonly:s})=>{const{updateDiagramUpdatedAt:a}=de(),{t}=Ne(),{redo:h,undo:l,hasRedo:p,hasUndo:m}=jt(),{getZoom:u,zoomIn:C,zoomOut:E,fitView:k}=le(),[S,O]=i.useState(Ze(u())),{isLostInCanvas:D}=vs();Ye({onChange:({zoom:M})=>{O(Ze(M))}});const y=200,v=()=>{C({duration:y})},d=()=>{E({duration:y})},w=()=>{k({minZoom:1,maxZoom:1,duration:y})},g=i.useCallback(()=>{k({duration:500,padding:.1,maxZoom:.8})},[k]);return e.jsx("div",{className:"px-1",children:e.jsx(Je,{className:"h-[44px] bg-secondary p-0 shadow-none",children:e.jsxs(Qe,{className:"flex h-full flex-row items-center p-1",children:[s?null:e.jsxs(e.Fragment,{children:[e.jsxs(Z,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(ie,{onClick:a,children:e.jsx(os,{})})})}),e.jsxs(Y,{children:[t("toolbar.save"),e.jsx("span",{className:"ml-2 text-muted-foreground",children:je[ke.SAVE_DIAGRAM].keyCombinationLabel})]})]}),e.jsx(Ce,{orientation:"vertical"})]}),e.jsxs(Z,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(ie,{onClick:g,className:D?"bg-pink-500 text-white hover:bg-pink-600 hover:text-white":"",children:e.jsx(ns,{})})})}),e.jsxs(Y,{children:[t("toolbar.show_all"),e.jsx("span",{className:"ml-2 text-muted-foreground",children:je[ke.SHOW_ALL].keyCombinationLabel})]})]}),e.jsx(Ce,{orientation:"vertical"}),e.jsxs(Z,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(ie,{onClick:d,children:e.jsx(cs,{})})})}),e.jsx(Y,{children:t("toolbar.zoom_out")})]}),e.jsx(se,{variant:"ghost",onClick:w,className:"w-[60px] p-2 hover:bg-primary-foreground",children:S}),e.jsxs(Z,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(ie,{onClick:v,children:e.jsx(ds,{})})})}),e.jsx(Y,{children:t("toolbar.zoom_in")})]}),e.jsx(Ce,{orientation:"vertical"}),e.jsxs(Z,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(ie,{onClick:l,disabled:!m,children:e.jsx(ls,{})})})}),e.jsxs(Y,{children:[t("toolbar.undo"),e.jsx("span",{className:"ml-2 text-muted-foreground",children:je[ke.UNDO].keyCombinationLabel})]})]}),e.jsxs(Z,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(ie,{onClick:h,disabled:!p,children:e.jsx(as,{})})})}),e.jsxs(Y,{children:[t("toolbar.redo"),e.jsx("span",{className:"ml-2 text-muted-foreground",children:je[ke.REDO].keyCombinationLabel})]})]})]})})})},ws=()=>{const{showCardinality:s}=Ke(),a={one:"1",many:"N"},t=["left","right"],h=[!0,!1];return s?e.jsx("svg",{className:"marker-definitions absolute left-0 top-0 z-0 size-0",children:e.jsx("defs",{children:Object.entries(a).map(([l,p])=>t.map(m=>h.map(u=>e.jsxs("marker",{id:we({cardinality:l,selected:u,side:m}),viewBox:"0 0 16 16",markerWidth:"16",markerHeight:"16",refX:m==="left"?"15":"1",refY:"8",children:[e.jsx("circle",{cx:"8",cy:"8",r:"5",className:L([u?"fill-pink-600":"fill-muted-foreground","stroke-background","stroke-[0.5]"])}),e.jsx("text",{x:"7.9",y:"8.4",fontSize:"6",fontWeight:"600",textAnchor:"middle",dominantBaseline:"middle",className:"fill-muted",children:p})]},we({cardinality:l,selected:u,side:m})))))})}):null},Ts=({children:s})=>{const{createTable:a,filteredSchemas:t,schemas:h,readonly:l,createArea:p}=de(),{openCreateRelationshipDialog:m,openTableSchemaDialog:u}=kt(),{screenToFlowPosition:C}=le(),{t:E}=Ne(),{isMd:k}=Ue("md"),S=i.useCallback(y=>{var d;const v=C({x:y.clientX,y:y.clientY});if(((t==null?void 0:t.length)??0)>1)u({onConfirm:w=>a({x:v.x,y:v.y,schema:w}),schemas:h.filter(w=>t==null?void 0:t.includes(w.id))});else{const w=(t==null?void 0:t.length)===1?(d=h.find(g=>g.id===t[0]))==null?void 0:d.name:void 0;a({x:v.x,y:v.y,schema:w})}},[a,C,u,h,t]),O=i.useCallback(y=>{const v=C({x:y.clientX,y:y.clientY});p({x:v.x,y:v.y})},[p,C]),D=i.useCallback(()=>{m()},[m]);return!k||l?e.jsx(e.Fragment,{children:s}):e.jsxs(vt,{children:[e.jsx(Ct,{children:s}),e.jsxs(wt,{children:[e.jsxs(_e,{onClick:S,className:"flex justify-between gap-4",children:[E("canvas_context_menu.new_table"),e.jsx(is,{className:"size-3.5"})]}),e.jsxs(_e,{onClick:D,className:"flex justify-between gap-4",children:[E("canvas_context_menu.new_relationship"),e.jsx(Tt,{className:"size-3.5"})]}),e.jsxs(_e,{onClick:O,className:"flex justify-between gap-4",children:[E("canvas_context_menu.new_area"),e.jsx(ts,{className:"size-3.5"})]})]})]})},Ns=({id:s,sourceX:a,sourceY:t,targetX:h,targetY:l,source:p,target:m,selected:u})=>{const{getInternalNode:C}=le(),{dependencies:E}=de(),{openDependencyFromSidebar:k,selectSidebarSection:S}=Te(),O=i.useCallback(()=>{S("dependencies"),k(s)},[s,k,S]),D=i.useMemo(()=>E.filter(b=>b.tableId===m&&b.dependentTableId===p||b.tableId===p&&b.dependentTableId===m).findIndex(b=>b.id===s),[E,s,p,m]),y=C(p),v=C(m),{sourceTopY:d,sourceBottomY:w,targetTopY:g,targetBottomY:M}=i.useMemo(()=>{const b=(y==null?void 0:y.measured.height)??0,R=t+5,F=t+b+10,K=(v==null?void 0:v.measured.height)??0,P=l+1,X=l+K+5;return{sourceTopY:R,sourceBottomY:F,targetTopY:P,targetBottomY:X}},[y==null?void 0:y.measured.height,t,v==null?void 0:v.measured.height,l]),{sourceSide:A,targetSide:T}=i.useMemo(()=>{const b={topToTop:Math.abs(d-g),topToBottom:Math.abs(d-M),bottomToTop:Math.abs(w-g),bottomToBottom:Math.abs(w-M)},R=Math.min(b.topToTop,b.topToBottom,b.bottomToTop,b.bottomToBottom);switch(Object.keys(b).find(K=>b[K]===R)){case"topToBottom":return{sourceSide:"top",targetSide:"bottom"};case"bottomToTop":return{sourceSide:"bottom",targetSide:"top"};case"bottomToBottom":return{sourceSide:"bottom",targetSide:"bottom"};default:return{sourceSide:"top",targetSide:"top"}}},[d,w,g,M]),[G]=i.useMemo(()=>We({sourceX:a,sourceY:A==="top"?d:w,targetX:h,targetY:T==="top"?g:M,borderRadius:14,sourcePosition:A==="top"?te.Top:te.Bottom,targetPosition:T==="top"?te.Top:te.Bottom,offset:(D+1)*14}),[D,w,A,d,a,M,T,g,h]);return e.jsxs(e.Fragment,{children:[e.jsx("path",{id:s,d:G,fill:"none",className:L(["react-flow__edge-path",`!stroke-2 ${u?"!stroke-pink-600":"!stroke-blue-400"}`]),onClick:b=>{b.detail===2&&O()}}),e.jsx("path",{d:G,fill:"none",strokeOpacity:0,strokeWidth:20,className:"react-flow__edge-interaction",onClick:b=>{b.detail===2&&O()}})]})},et=U.memo(({selected:s,dragging:a,data:{area:t}})=>{const{updateArea:h,readonly:l}=de(),{t:p}=Ne(),[m,u]=i.useState(!1),[C,E]=i.useState(t.name),k=U.useRef(null),{openAreaFromSidebar:S,selectSidebarSection:O}=Te(),D=!!s&&!a,y=i.useCallback(()=>{m&&(C.trim()&&h(t.id,{name:C.trim()}),u(!1))},[C,t.id,h,m]),v=i.useCallback(()=>{u(!1),E(t.name)},[t.name]),d=i.useCallback(()=>{O("areas"),S(t.id)},[O,S,t.id]);Nt(k,y),Be("Enter",y),Be("Escape",v);const w=g=>{g.stopPropagation(),u(!0)};return e.jsxs("div",{className:L("flex h-full flex-col rounded-md border-2 shadow-sm",s?"border-pink-600":"border-transparent"),style:{backgroundColor:`${t.color}15`,borderColor:s?void 0:t.color},onClick:g=>{g.detail===2&&d()},children:[e.jsx(It,{isVisible:D,lineClassName:"!border-4 !border-transparent",handleClassName:"!h-3 !w-3 !rounded-full !bg-pink-600"}),e.jsx("div",{className:"group flex h-8 items-center justify-between rounded-t-md px-2",children:e.jsxs("div",{className:"flex w-full items-center gap-1",children:[e.jsx(es,{className:"size-4 text-slate-700 opacity-60 dark:text-slate-300"}),m&&!l?e.jsxs("div",{className:"flex w-full items-center",children:[e.jsx(St,{ref:k,autoFocus:!0,type:"text",placeholder:t.name,value:C,onClick:g=>g.stopPropagation(),onChange:g=>E(g.target.value),className:"h-6 bg-white/70 focus-visible:ring-0 dark:bg-slate-900/70"}),e.jsx(se,{variant:"ghost",className:"ml-1 size-6 p-0 hover:bg-white/20",onClick:y,children:e.jsx(Et,{className:"size-3.5 text-slate-700 dark:text-slate-300"})})]}):l?e.jsx("div",{className:"truncate px-1 py-0.5 text-base font-semibold text-slate-700 dark:text-slate-300",children:t.name}):e.jsxs(Z,{children:[e.jsx(W,{asChild:!0,children:e.jsx("div",{className:"text-editable max-w-[200px] cursor-text truncate px-1 py-0.5 text-base font-semibold text-slate-700 dark:text-slate-300",onDoubleClick:w,children:t.name})}),e.jsx(Y,{children:p("tool_tips.double_click_to_edit")})]})]})}),e.jsx("div",{className:"flex-1"})]})});et.displayName="AreaNode";const Is={"relationship-edge":xs,"dependency-edge":Ns},Ss={table:Zt,area:et},Es=[],Me=(s,a)=>({id:s.id,type:"table",position:{x:s.x,y:s.y},data:{table:s,isOverlapping:!1},width:s.width??Dt,hidden:!Oe(s,a)}),Rs=s=>({id:s.id,type:"area",position:{x:s.x,y:s.y},data:{area:s},width:s.width,height:s.height,zIndex:-10}),Hs=({initialTables:s})=>{const{getEdge:a,getInternalNode:t,getEdges:h,getNode:l}=le(),[p,m]=i.useState([]),[u,C]=i.useState([]),{toast:E}=Rt(),{t:k}=Ne(),{tables:S,areas:O,relationships:D,createRelationship:y,createDependency:v,updateTablesState:d,removeRelationships:w,removeDependencies:g,getField:M,databaseType:A,filteredSchemas:T,events:G,dependencies:b,readonly:R,removeArea:F,updateArea:K}=de(),{showSidePanel:P}=Te(),{effectiveTheme:X}=Jt(),{scrollAction:ae,showDependenciesOnCanvas:J,showMiniMapOnCanvas:ue}=Ke(),{showAlert:me}=_t(),{isMd:re}=Ue("md"),[fe,ge]=i.useState(!1),{reorderTables:oe,fitView:ne,setOverlapGraph:j,overlapGraph:H}=Mt(),[Ie,xe]=i.useState(!0),[B,De,ze]=Ot(s.map(n=>Me(n,T))),[Se,ye,Ae]=zt(Es),[Fe,tt]=i.useState(!1);i.useEffect(()=>{xe(!0)},[s]),i.useEffect(()=>{const n=s.map(r=>Me(r,T));ve(n,B)&&xe(!1)},[s,B,T]),i.useEffect(()=>{Ie||Re(()=>{ne({duration:200,padding:.1,maxZoom:.8})},500)()},[Ie,ne]),i.useEffect(()=>{const n=D.reduce((o,x)=>(o[`${x.targetTableId}${x.targetFieldId}`]=0,o),{}),r=b.reduce((o,x)=>(o[x.tableId]=0,o),{});ye([...D.map(o=>({id:o.id,source:o.sourceTableId,target:o.targetTableId,sourceHandle:`${Ft}${o.sourceFieldId}`,targetHandle:`${At}${n[`${o.targetTableId}${o.targetFieldId}`]++}_${o.targetFieldId}`,type:"relationship-edge",data:{relationship:o}})),...b.map(o=>({id:o.id,source:o.dependentTableId,target:o.tableId,sourceHandle:`${Ve}${o.dependentTableId}`,targetHandle:`${Ht}${r[o.tableId]++}_${o.tableId}`,type:"dependency-edge",data:{dependency:o},hidden:!J&&A!==Qt.CLICKHOUSE}))])},[D,b,ye,J,A]),i.useEffect(()=>{const n=B.filter(r=>r.selected).map(r=>r.id);ve(n,p)||m(n)},[B,m,p]),i.useEffect(()=>{const n=Se.filter(r=>r.selected).map(r=>r.id);ve(n,u)||C(n)},[Se,C,u]),i.useEffect(()=>{const r=[...h().filter(o=>p.includes(o.source)||p.includes(o.target)).map(o=>o.id),...u];ye(o=>o.map(x=>{const f=r.includes(x.id);if(x.type==="dependency-edge"){const N=x;return{...N,data:{...N.data,highlighted:f},animated:f,zIndex:f?1:0}}else{const N=x;return{...N,data:{...N.data,highlighted:f},animated:f,zIndex:f?1:0}}}))},[u,p,ye,h]),i.useEffect(()=>{De([...S.map(n=>{const r=(H.graph.get(n.id)??[]).length>0,o=Me(n,T);return{...o,data:{...o.data,isOverlapping:r,highlightOverlappingTables:fe}}}),...O.map(Rs)])},[S,O,De,T,H.lastUpdated,H.graph,fe]);const He=i.useRef(void 0);i.useEffect(()=>{ve(T,He.current)||(Re(()=>{const n=$e({tables:S.filter(r=>Oe(r,T))});j(n),ne({duration:500,padding:.1,maxZoom:.8})},500)(),He.current=T)},[T,ne,S,j]);const st=i.useCallback(async n=>{var z,I,_,V,q,Q,ee,ce;if((I=(z=n.sourceHandle)==null?void 0:z.startsWith)!=null&&I.call(z,Ve)||(V=(_=n.sourceHandle)==null?void 0:_.startsWith)!=null&&V.call(_,Lt)){const he=n.target,pt=n.source;v({tableId:he,dependentTableId:pt});return}const r=n.source,o=n.target,x=((Q=(q=n.sourceHandle)==null?void 0:q.split("_"))==null?void 0:Q.pop())??"",f=((ce=(ee=n.targetHandle)==null?void 0:ee.split("_"))==null?void 0:ce.pop())??"",N=M(r,x),c=M(o,f);if(!(!N||!c)){if(!Pt(N.type,c.type,A)){E({title:"Field types are not compatible",variant:"destructive",description:"Relationships can only be created between compatible field types"});return}y({sourceTableId:r,targetTableId:o,sourceFieldId:x,targetFieldId:f})}},[y,v,M,E,A]),at=i.useCallback(n=>{let r=n;R&&(r=r.filter(c=>c.type!=="remove"));const x=r.filter(c=>c.type==="remove").map(c=>a(c.id)).filter(c=>!!c),f=x.filter(c=>(c==null?void 0:c.type)==="relationship-edge").map(c=>{var z,I;return(I=(z=c==null?void 0:c.data)==null?void 0:z.relationship)==null?void 0:I.id}),N=x.filter(c=>(c==null?void 0:c.type)==="dependency-edge").map(c=>{var z,I;return(I=(z=c==null?void 0:c.data)==null?void 0:z.dependency)==null?void 0:I.id});return f.length>0&&w(f),N.length>0&&g(N),Ae(r)},[a,Ae,w,g,R]),ot=i.useCallback(({positionChanges:n,sizeChanges:r})=>{if(n.length>0||r.length>0){let o=H;for(const x of n){const f=l(x.id);f&&f.type==="table"&&(o=pe({node:f},{nodes:B.filter(N=>!N.hidden&&N.type==="table")},o))}for(const x of r){const f=l(x.id);f&&f.type==="table"&&(o=pe({node:f},{nodes:B.filter(N=>!N.hidden&&N.type==="table")},o))}j(o)}},[B,H,j,l]),Le=Re(ot,200),Ee=i.useCallback((n,r)=>{const o=n.filter(c=>{if(c.type==="position"||c.type==="dimensions"||c.type==="remove"){const z=l(c.id);return!(!z||z.type!==r)}return!1}),x=o.filter(c=>c.type==="position"&&!c.dragging),f=o.filter(c=>c.type==="remove"),N=o.filter(c=>c.type==="dimensions"&&c.resizing);return{positionChanges:x,removeChanges:f,sizeChanges:N}},[l]),nt=i.useCallback(n=>{let r=n;R&&(r=r.filter(I=>I.type!=="remove"));const{positionChanges:o,removeChanges:x,sizeChanges:f}=Ee(r,"table");(o.length>0||x.length>0||f.length>0)&&d(I=>I.map(_=>{var Q,ee,ce;const V=o.find(he=>he.id===_.id),q=f.find(he=>he.id===_.id);return V||q?{id:_.id,...V?{x:(Q=V.position)==null?void 0:Q.x,y:(ee=V.position)==null?void 0:ee.y}:{},...q?{width:((ce=q.dimensions)==null?void 0:ce.width)??_.width}:{}}:_}).filter(_=>!x.some(V=>V.id===_.id))),Le({positionChanges:o,sizeChanges:f});const{positionChanges:N,removeChanges:c,sizeChanges:z}=Ee(r,"area");return(N.length>0||c.length>0||z.length>0)&&([...N,...z].forEach(I=>{var V,q,Q,ee;const _={};I.type==="position"&&(_.x=(V=I.position)==null?void 0:V.x,_.y=(q=I.position)==null?void 0:q.y),I.type==="dimensions"&&(_.width=(Q=I.dimensions)==null?void 0:Q.width,_.height=(ee=I.dimensions)==null?void 0:ee.height),Object.keys(_).length>0&&K(I.id,_)}),c.forEach(I=>{F(I.id)})),ze(r)},[ze,d,Le,Ee,K,F,R]),it=i.useCallback(n=>{let r=H;if(n.action==="add_tables"){for(const o of n.data.tables)r=pe({node:l(o.id)},{nodes:B.filter(x=>!x.hidden&&x.type==="table")},H);j(r)}else if(n.action==="remove_tables"){for(const o of n.data.tableIds)r=Bt(r,o);j(r)}else if(n.action==="update_table"&&n.data.table.width){const o=l(n.data.id),x={...o.measured,width:n.data.table.width};r=pe({node:{...o,measured:x}},{nodes:B.filter(f=>!f.hidden&&f.type==="table")},H),j(r)}else if(n.action==="add_field"||n.action==="remove_field"){const o=l(n.data.tableId),x={...o.measured??{},height:Vt(n.data.fields.length)};r=pe({node:{...o,measured:x}},{nodes:B.filter(f=>!f.hidden&&f.type==="table")},H),j(r)}else if(n.action==="load_diagram"){const o=n.data.diagram.tables??[],x=$e({tables:o.filter(f=>Oe(f,T))});j(x)}},[H,j,l,B,T]);G.useSubscription(it);const rt=S.length>0?!t(S[0].id):!1,lt=i.useCallback(()=>{me({title:k("reorder_diagram_alert.title"),description:k("reorder_diagram_alert.description"),actionLabel:k("reorder_diagram_alert.reorder"),closeLabel:k("reorder_diagram_alert.cancel"),onAction:oe})},[k,me,oe]),dt=i.useMemo(()=>Array.from(H.graph).some(([,n])=>n.length>0),[H]),ct=i.useCallback(()=>{ge(!0),setTimeout(()=>ge(!1),600)},[]),Pe=$t("Shift"),ht=ft();return e.jsx(Ts,{children:e.jsxs("div",{className:"relative flex h-full",id:"canvas",children:[e.jsxs(Gt,{onlyRenderVisibleElements:!0,colorMode:X,className:"canvas-cursor-default nodes-animated",nodes:B,edges:Se,onNodesChange:nt,onEdgesChange:at,maxZoom:5,minZoom:.1,onConnect:st,proOptions:{hideAttribution:!0},fitView:!1,nodeTypes:Ss,edgeTypes:Is,defaultEdgeOptions:{animated:!1,type:"relationship-edge"},panOnScroll:ae==="pan",snapToGrid:Pe||Fe,snapGrid:[20,20],children:[e.jsx(be,{position:"top-left",showZoom:!1,showFitView:!1,showInteractive:!1,className:"!shadow-none",children:e.jsxs("div",{className:"flex flex-col items-center gap-2 md:flex-row",children:[R?null:e.jsxs(e.Fragment,{children:[e.jsxs(Z,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(se,{variant:"secondary",className:"size-8 p-1 shadow-none",onClick:lt,children:e.jsx(Wt,{className:"size-4"})})})}),e.jsx(Y,{children:k("toolbar.reorder_diagram")})]}),e.jsxs(Z,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(se,{variant:"secondary",className:L("size-8 p-1 shadow-none",Fe||Pe?"bg-pink-600 text-white hover:bg-pink-500 dark:hover:bg-pink-700 hover:text-white":""),onClick:()=>tt(n=>!n),children:e.jsx(ss,{className:"size-4"})})})}),e.jsx(Y,{children:k("snap_to_grid_tooltip",{key:ht==="mac"?"⇧":"Shift"})})]})]}),e.jsx("div",{className:`transition-opacity duration-300 ease-in-out ${dt?"opacity-100":"opacity-0"}`,children:e.jsxs(Z,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(se,{variant:"default",className:"size-8 p-1 shadow-none",onClick:ct,children:e.jsx(rs,{className:"size-4 text-white"})})})}),e.jsx(Y,{children:k("toolbar.highlight_overlapping_tables")})]})})]})}),rt?e.jsx(be,{position:"top-center",orientation:"horizontal",showZoom:!1,showFitView:!1,showInteractive:!1,className:"!shadow-none",children:e.jsx(qt,{variant:"default",className:"bg-pink-600 text-white",children:k("loading_diagram")})}):null,!re&&!R?e.jsx(be,{position:"bottom-left",orientation:"horizontal",showZoom:!1,showFitView:!1,showInteractive:!1,className:"!shadow-none",children:e.jsx(se,{className:"size-11 bg-pink-600 p-2 hover:bg-pink-500",onClick:P,children:e.jsx(Yt,{})})}):null,e.jsx(be,{position:re?"bottom-center":"top-center",orientation:"horizontal",showZoom:!1,showFitView:!1,showInteractive:!1,className:"!shadow-none",children:e.jsx(Cs,{readonly:R})}),ue&&e.jsx(Ut,{style:{width:re?100:60,height:re?100:60}}),e.jsx(Kt,{variant:Xt.Dots,gap:16,size:1})]}),e.jsx(ws,{})]})})};export{Hs as C,ts as G,Ce as S,is as T,os as a,es as b,ve as e};
